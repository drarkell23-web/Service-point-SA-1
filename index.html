<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>OmniSolutions ‚Äî All-in-One Service Network</title>
<link rel="stylesheet" href="theme.css">
<script type="module" src="Firebase-bridge.js" defer></script>
<script type="module" src="confetti.js" defer></script>
</head>
<body>
  <div class="shell">
    <aside class="leftbar">
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <button id="btnContractor" class="btn">Contractor Dashboard</button>
        <button id="btnReviews" class="btn">Reviews</button>
        <button id="btnAdmin" class="btn" style="margin-left:auto;display:none;background:linear-gradient(90deg,#ff9a00,#ff4d6d)">Admin</button>
      </div>

      <h3 style="color:var(--muted)">Categories</h3>
      <div id="categoriesContainer" style="display:flex;flex-direction:column;gap:12px;max-height:68vh;overflow:auto"></div>

      <div style="margin-top:12px;border-top:1px solid #ffffff08;padding-top:12px">
        <button id="btnTop" class="btn" style="width:100%">Top Contractors</button>
      </div>
    </aside>

    <main class="content">
      <header class="card header-row">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo-mini"></div>
          <div>
            <h1 style="margin:0">OmniSolutions</h1>
            <div class="small" style="color:var(--muted)">Find verified local contractors fast</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="btnTopHeader" class="btn">Top Contractors</button>
        </div>
      </header>

      <section class="card">
        <h2>Popular Services</h2>
        <div id="popular" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:12px"></div>
      </section>

      <section class="card">
        <h2>Testimonials</h2>
        <div id="testimonials" style="display:flex;gap:12px;align-items:center;overflow:hidden;position:relative">
          <!-- Auto-rotating testimonial cards will be injected here -->
        </div>
      </section>
    </main>
  </div>

  <!-- Local services modal -->
  <div id="localOverlay" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(2,2,6,0.75);z-index:9999;align-items:center;justify-content:center">
    <div style="background:linear-gradient(180deg,#0b0813,#0d0a17);padding:18px;border-radius:12px;width:920px;max-width:96%;color:var(--ink)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="localTitle">Local Services</h3>
        <div><button id="closeLocal" class="btn">Close</button></div>
      </div>
      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="width:320px">
          <div id="localServiceName" class="mini"></div>
          <h4 style="margin:8px 0">Top 3 Contractors</h4>
          <div id="top3" style="display:flex;flex-direction:column;gap:10px"></div>
        </div>
        <div style="flex:1">
          <h4 style="margin:8px 0">All Local Contractors</h4>
          <div id="localList" style="display:flex;flex-direction:column;gap:12px;max-height:420px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat widget (floating) -->
  <button id="chatOpen" class="admin-btn">Chat</button>
  <div id="chatWindow" style="display:none;position:fixed;right:18px;bottom:80px;width:380px;max-width:92vw;z-index:10000;border-radius:12px;overflow:hidden">
    <div style="background:linear-gradient(90deg,var(--accent-from),var(--accent-to));padding:10px;color:white;font-weight:700">Omni Chat</div>
    <div id="chatMsgs" style="background:linear-gradient(180deg,#070416,#0b0813);height:320px;overflow:auto;padding:12px;display:flex;flex-direction:column-reverse"></div>
    <div style="display:flex;gap:8px;padding:10px;background:#070417;">
      <input id="chatInput" class="small-input" placeholder="Type your message..." style="flex:1">
      <button id="chatSend" class="btn">Send</button>
    </div>
  </div>

  <canvas id="confettiCanvas" style="position:fixed;left:0;top:0;right:0;pointer-events:none;z-index:2200"></canvas>

<script type="module">
import confettiSpark from './confetti.js';
import { createLead } from './Firebase-bridge.js';

confettiSpark.init(document.getElementById('confettiCanvas'));

async function loadServices() {
  const res = await fetch('/api/services'); const j = await res.json(); return j.services || [];
}
async function loadContractors() {
  const res = await fetch('/api/contractors'); const j = await res.json(); return j.contractors || [];
}

let SERVICES = [], CONTRACTORS = [];
(async ()=>{
  SERVICES = await loadServices();
  CONTRACTORS = await loadContractors();

  // build categories
  const cats = [...new Set(SERVICES.map(s => s.cat))];
  const container = document.getElementById('categoriesContainer');
  cats.forEach(cat => {
    const row = document.createElement('div');
    row.innerHTML = `<div class="cat-toggle">${cat} <span style="opacity:.6">‚ñ∏</span></div><div class="services-list"></div>`;
    const sl = row.querySelector('.services-list');
    SERVICES.filter(s => s.cat === cat).forEach(s => {
      const b = document.createElement('button'); b.className='svc-bubble'; b.textContent=s.name;
      b.addEventListener('click', ()=> openLocal(s));
      sl.appendChild(b);
    });
    row.querySelector('.cat-toggle').addEventListener('click', ()=> {
      sl.classList.toggle('open');
      row.querySelector('.cat-toggle span').textContent = sl.classList.contains('open') ? '‚ñæ' : '‚ñ∏';
    });
    container.appendChild(row);
  });

  // popular grid
  const pop = document.getElementById('popular');
  SERVICES.slice(0,24).forEach(s => {
    const el = document.createElement('div'); el.className='service-card';
    el.innerHTML = `<div style="font-weight:800">${s.name}</div><div class="small" style="color:var(--muted)">${s.cat}</div><div style="margin-top:8px"><button class="btn chooseBtn">Choose</button></div>`;
    el.querySelector('.chooseBtn').addEventListener('click', ()=> openLocal(s));
    pop.appendChild(el);
  });

  // testimonials (rotating sample)
  const tWrap = document.getElementById('testimonials');
  const example = [
    {name:"Janine P.", text:"Quick and reliable. Fixed my roof same day!", rating:5},
    {name:"Sipho M.", text:"Amazing cleaners. Left the place spotless.", rating:5},
    {name:"Daniela R.", text:"Professional and on time. Highly recommend.", rating:4.8}
  ];
  example.forEach(x=>{
    const c = document.createElement('div'); c.style.minWidth='260px'; c.style.borderRadius='12px'; c.style.padding='12px'; c.style.background='#0b0714';
    c.innerHTML = `<div style="font-weight:800">${x.name}</div><div class="small" style="color:var(--muted);margin:8px 0">${x.text}</div><div style="font-weight:700">‚≠ê ${x.rating}</div>`;
    tWrap.appendChild(c);
  });
  // simple auto-scroll for testimonials
  let pos = 0;
  setInterval(()=> {
    pos = (pos + 1) % tWrap.children.length;
    tWrap.style.transform = `translateX(-${pos * 280}px)`;
    tWrap.style.transition = 'transform 600ms ease';
  }, 4000);

})();

function openLocal(service) {
  document.getElementById('localOverlay').style.display = 'flex';
  document.getElementById('localServiceName').textContent = `${service.name} ‚Äî ${service.cat}`;
  const matches = CONTRACTORS.filter(c => (c.service && c.service.toLowerCase().includes(service.cat.split(' ')[0].toLowerCase())) || (c.tags && c.tags.includes(service.name)));
  const showList = matches.length ? matches : CONTRACTORS;
  const top3 = [...showList].sort((a,b)=> (b.rating||0) - (a.rating||0)).slice(0,3);
  const top3Wrap = document.getElementById('top3'); top3Wrap.innerHTML = '';
  top3.forEach(c => top3Wrap.appendChild(renderContractor(c, true)));
  const localList = document.getElementById('localList'); localList.innerHTML = '';
  showList.forEach(c => localList.appendChild(renderContractor(c, false)));
}

function renderContractor(c, isTop) {
  const el = document.createElement('div'); el.className = 'contractor-card';
  const logo = document.createElement('img'); logo.className='contractor-logo'; logo.src = c.logoUrl || '/assets/default-logo.png';
  const info = document.createElement('div'); info.className='contractor-info';
  info.innerHTML = `<div style="font-weight:800">${c.company || c.name || 'Unnamed'}</div><div class="small" style="color:var(--muted)">${c.service || c.tags?.join(', ') || 'General'}</div><div style="margin-top:8px" class="small">üìû ${c.phone || '-'} &nbsp; ‚Ä¢ &nbsp; ‚≠ê ${(c.rating||0).toFixed(1)}</div>`;
  const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Contact';
  btn.addEventListener('click', ()=> {
    openChatForContractor(c);
    document.getElementById('localOverlay').style.display = 'none';
  });
  el.appendChild(logo); el.appendChild(info); el.appendChild(btn);
  if (isTop) {
    const badge = document.createElement('img'); badge.className='badge-img'; badge.src = c.badge ? `/badges/${c.badge}.png` : '/badges/platinum.png';
    el.appendChild(badge);
  }
  return el;
}

document.getElementById('closeLocal').addEventListener('click', ()=> document.getElementById('localOverlay').style.display = 'none');

function openChatForContractor(c) {
  // open chat and prefill contractor id so lead goes to them too
  const chatOpen = document.getElementById('chatOpen');
  chatOpen.click();
  // store contractor preference in a global var (chat handler reads it)
  window.__PREFERRED_CONTRACTOR = c.id;
}

/* CHAT widget basic flow (multi-step) */
const chatOpenBtn = document.getElementById('chatOpen');
const chatWindow = document.getElementById('chatWindow');
const chatMsgs = document.getElementById('chatMsgs');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');

let convo = { step:0, data:{} };

chatOpenBtn.addEventListener('click', ()=> {
  chatWindow.style.display = chatWindow.style.display === 'none' ? 'block' : 'none';
  if (chatWindow.style.display === 'block') startConvo();
});
chatSend.addEventListener('click', handleChat);
chatInput.addEventListener('keydown', e => { if (e.key === 'Enter') handleChat(); });

function pushBot(text) {
  const el = document.createElement('div'); el.style.padding='10px'; el.style.borderRadius='8px'; el.style.background='#0f0b1a'; el.style.marginBottom='8px'; el.style.color='var(--muted)'; el.textContent = text;
  chatMsgs.prepend(el);
}
function pushUser(text) {
  const el = document.createElement('div'); el.style.padding='8px'; el.style.borderRadius='8px'; el.style.background='linear-gradient(90deg,var(--accent-from),var(--accent-to))'; el.style.color='white'; el.style.marginBottom='8px'; el.style.alignSelf='flex-end'; el.textContent = text;
  chatMsgs.prepend(el);
}

function startConvo() {
  convo = { step:1, data: {} };
  chatMsgs.innerHTML = '';
  pushBot("Hi ‚Äî I'm OmniChat. What's your full name?");
  chatInput.focus();
}

async function handleChat() {
  const text = chatInput.value.trim(); if (!text) return;
  pushUser(text); chatInput.value = '';
  if (convo.step === 1) { convo.data.name = text; convo.step = 2; pushBot("Phone number?"); }
  else if (convo.step === 2) { convo.data.phone = text; convo.step = 3; pushBot("Your address or suburb?"); }
  else if (convo.step === 3) { convo.data.address = text; convo.step = 4; pushBot("When would you like the service? (ASAP / Date)"); }
  else if (convo.step === 4) { convo.data.when = text; convo.step = 5; pushBot("Short details about the job"); }
  else if (convo.step === 5) {
    convo.data.details = text;
    pushBot("Sending your request now...");
    confettiSpark.shoot(90);
    const payload = {
      name: convo.data.name,
      phone: convo.data.phone,
      email: "",
      service: convo.data.service || "General",
      message: `When: ${convo.data.when || '-'}\nAddress: ${convo.data.address || '-'}\nDetails: ${convo.data.details || '-'}`,
      contractorId: window.__PREFERRED_CONTRACTOR
    };
    try {
      await createLead(payload);
      const r = await fetch('/api/lead', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
      const j = await r.json();
      if (j && j.ok) pushBot("‚úÖ Request sent. Contractors will contact you shortly.");
      else pushBot("‚ùå Failed to send. Try again later.");
    } catch (err) { console.error(err); pushBot("‚ùå Network error sending request."); }
    convo = { step:0, data:{} };
  }
}

/* admin visibility */
(async ()=>{
  try {
    const r = await fetch('/api/admin-secret'); const j = await r.json();
    if (j && j.secret) {
      document.getElementById('btnAdmin').style.display = 'inline-block';
    }
  } catch(e){}
})();
</script>
</body>
</html>
